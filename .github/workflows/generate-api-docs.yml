name: Generate and Deploy API Documentation

on:
  push:
    branches: [ main ]
    paths: 
      - 'src/**'
      - 'build.gradle'
      - '.github/workflows/generate-api-docs.yml'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Make gradlew executable
      run: chmod +x gradlew
      
    - name: Build Application
      run: |
        echo "ğŸ”¨ Building application..."
        ./gradlew clean build -x test --no-daemon --stacktrace
        
        echo "ğŸ“¦ Checking JAR file..."
        ls -la build/libs/
        JAR_FILE=$(find build/libs -name "*.jar" | head -1)
        echo "JAR file: $JAR_FILE"
        echo "JAR size: $(du -h $JAR_FILE | cut -f1)"
      
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install pyyaml requests
        
    - name: Start Application and Generate API Docs
      timeout-minutes: 10
      run: |
        echo "ğŸš€ Starting Spring Boot application with swagger profile..."
        
        # ë” ëª…í™•í•œ JVM ì„¤ì •ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
        java -server \
             -Xmx1024m \
             -Dspring.profiles.active=swagger \
             -Dserver.port=8080 \
             -Dspring.datasource.url=jdbc:h2:mem:testdb \
             -Dspring.datasource.driver-class-name=org.h2.Driver \
             -Dspring.jpa.hibernate.ddl-auto=create-drop \
             -Djwt.secret=dGVzdC1zZWNyZXQta2V5LWZvci1zd2FnZ2VyLWRvY3VtZW50YXRpb24tZ2VuZXJhdGlvbg== \
             -Dkakao.client-id=dummy-client-id \
             -Dkakao.client-secret=dummy-client-secret \
             -Dlogging.level.org.springframework.cloud.gcp=WARN \
             -Dlogging.level.com.google.cloud=WARN \
             -Dlogging.level.redis=WARN \
             -Dlogging.level.org.redisson=WARN \
             -jar build/libs/*.jar > app.log 2>&1 &
        APP_PID=$!
        echo "Started application with PID: $APP_PID"
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ë” ê¸´ íƒ€ì„ì•„ì›ƒ)
        echo "â³ Waiting for application to be ready..."
        READY=false
        for i in {1..50}; do
          if curl -s -f http://localhost:8080/actuator/health >/dev/null 2>&1; then
            echo "âœ… Application is ready after $((i*6)) seconds!"
            READY=true
            break
          fi
          echo "Attempt $i/50... (waiting 6s)"
          sleep 6
          
          # ë””ë²„ê·¸ ëª¨ë“œì—ì„œëŠ” ë¡œê·¸ ì¼ë¶€ ì¶œë ¥
          if [ "${{ inputs.debug }}" = "true" ] && [ $((i % 5)) -eq 0 ]; then
            echo "==== Recent logs ===="
            tail -20 app.log 2>/dev/null || echo "No logs yet"
            echo "==================="
          fi
        done
        
        if [ "$READY" = false ]; then
          echo "âŒ Application failed to start within timeout. Logs:"
          echo "==== FULL APPLICATION LOG ===="
          cat app.log
          echo "==== END LOG ===="
          kill $APP_PID 2>/dev/null || true
          exit 1
        fi
        
        # ì¶”ê°€ ëŒ€ê¸° ì‹œê°„ (ì™„ì „í•œ ì´ˆê¸°í™” ë³´ì¥)
        echo "âŒ› Waiting additional time for full startup..."
        sleep 15
        
        # API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
        echo "ğŸ” Checking available endpoints..."
        curl -s http://localhost:8080/actuator/health | jq . 2>/dev/null || echo "Health check response received"
        
        # OpenAPI JSON ë‹¤ìš´ë¡œë“œ
        echo "ğŸ“¥ Downloading OpenAPI specification..."
        MAX_RETRIES=3
        for attempt in $(seq 1 $MAX_RETRIES); do
          if curl -f -H "Accept: application/json" http://localhost:8080/v3/api-docs -o openapi-temp.json; then
            echo "âœ… OpenAPI spec downloaded successfully on attempt $attempt"
            break
          else
            echo "âŒ Failed to download OpenAPI spec (attempt $attempt/$MAX_RETRIES)"
            if [ $attempt -eq $MAX_RETRIES ]; then
              echo "Final attempt failed. Application logs:"
              tail -50 app.log
              echo "Available endpoints:"
              curl -s http://localhost:8080/actuator || echo "No actuator response"
              kill $APP_PID 2>/dev/null || true
              exit 1
            fi
            sleep 5
          fi
        done
        
        # JSON íŒŒì¼ ê²€ì¦
        echo "ğŸ” Validating downloaded OpenAPI JSON..."
        if ! python3 -c "import json; json.load(open('openapi-temp.json'))"; then
          echo "âŒ Invalid JSON file downloaded"
          echo "File content:"
          head -20 openapi-temp.json
          kill $APP_PID 2>/dev/null || true
          exit 1
        fi
        
        # JSONì„ YAMLë¡œ ë³€í™˜
        echo "ğŸ“ Converting JSON to YAML..."
        python3 << 'EOF'
        import json
        import yaml
        import sys
        
        try:
            # JSON íŒŒì¼ ì½ê¸°
            with open('openapi-temp.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # ê¸°ë³¸ ê²€ì¦
            if not data.get('openapi'):
                print("âŒ Invalid OpenAPI format: missing 'openapi' field")
                sys.exit(1)
                
            if not data.get('info'):
                print("âŒ Invalid OpenAPI format: missing 'info' field")
                sys.exit(1)
                
            if not data.get('paths'):
                print("âŒ No API paths found in OpenAPI specification")
                sys.exit(1)
            
            # YAML íŒŒì¼ë¡œ ì €ì¥
            with open('docs/openapi.yaml', 'w', encoding='utf-8') as f:
                yaml.dump(data, f, default_flow_style=False, allow_unicode=True, sort_keys=False)
            
            print(f"âœ… OpenAPI YAML generated successfully!")
            print(f"ğŸ“Š API paths found: {len(data['paths'])}")
            print(f"ğŸ“‹ API title: {data['info'].get('title', 'Unknown')}")
            print(f"ğŸ“Œ API version: {data['info'].get('version', 'Unknown')}")
            
        except Exception as e:
            print(f"âŒ Error converting JSON to YAML: {e}")
            sys.exit(1)
        EOF
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€
        echo "ğŸ›‘ Stopping application..."
        kill $APP_PID 2>/dev/null || true
        sleep 5
        
        # í”„ë¡œì„¸ìŠ¤ê°€ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘ì´ë©´ ê°•ì œ ì¢…ë£Œ
        if kill -0 $APP_PID 2>/dev/null; then
          echo "Force killing application..."
          kill -9 $APP_PID 2>/dev/null || true
        fi
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm -f openapi-temp.json
        
        echo "ğŸ“Š Generated OpenAPI spec statistics:"
        wc -l docs/openapi.yaml
        echo "File size: $(du -h docs/openapi.yaml | cut -f1)"
        
        echo "ğŸ” First few lines of generated spec:"
        head -20 docs/openapi.yaml
        
    - name: Validate Generated Docs
      run: |
        if [ ! -f "docs/openapi.yaml" ]; then
          echo "âŒ OpenAPI YAML file not found!"
          exit 1
        fi
        
        # íŒŒì¼ í¬ê¸° ê²€ì¦ (ë„ˆë¬´ ì‘ìœ¼ë©´ ë¬¸ì œ)
        FILE_SIZE=$(wc -l < docs/openapi.yaml)
        if [ $FILE_SIZE -lt 50 ]; then
          echo "âŒ Generated OpenAPI spec seems too small (${FILE_SIZE} lines)!"
          echo "Content:"
          cat docs/openapi.yaml
          exit 1
        fi
        
        # YAML êµ¬ë¬¸ ê²€ì¦
        if ! python3 -c "import yaml; yaml.safe_load(open('docs/openapi.yaml'))"; then
          echo "âŒ Generated YAML file is invalid!"
          exit 1
        fi
        
        # OpenAPI ê¸°ë³¸ í•„ë“œ ê²€ì¦
        python3 << 'EOF'
        import yaml
        import sys
        
        with open('docs/openapi.yaml', 'r') as f:
            data = yaml.safe_load(f)
        
        if not data.get('openapi'):
            print("âŒ Missing OpenAPI version field")
            sys.exit(1)
            
        if not data.get('info'):
            print("âŒ Missing info section")
            sys.exit(1)
            
        if not data.get('paths'):
            print("âŒ No API paths found")
            sys.exit(1)
            
        print(f"âœ… OpenAPI documentation validated successfully!")
        print(f"ğŸ“Š Total API endpoints: {len(data['paths'])}")
        EOF
      
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './docs'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Success Notification
      run: |
        echo "ğŸ‰ API Documentation deployment completed!"
        echo "ğŸ“– Documentation URL: https://100-hours-a-week.github.io/15-Leafresh-BE/"
        echo "ğŸ”— Direct link: ${{ steps.deployment.outputs.page_url }}"
        
        # ìƒì„±ëœ ë¬¸ì„œ í†µê³„
        if [ -f "docs/openapi.yaml" ]; then
          LINES=$(wc -l < docs/openapi.yaml)
          SIZE=$(du -h docs/openapi.yaml | cut -f1)
          echo "ğŸ“Š Generated OpenAPI spec: ${LINES} lines, ${SIZE}"
        fi
